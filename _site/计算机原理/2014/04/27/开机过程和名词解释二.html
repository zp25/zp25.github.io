<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>开机过程和名词解释II - MBR 和 GPT</title>
        <meta name="viewport" content="width=device-width">

        <!-- favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- RSS Feed -->
        <link rel="alternate" type="application/rss+xml" title="RSS" href="feed.xml">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">ZP</a></h1>
            <a class="extra" href="/">home</a>
            <a class="extra" href="/categories.html">categories</a>
          </div>

          <h2>开机过程和名词解释II - MBR 和 GPT</h2>
<p class="meta">27 Apr 2014</p>

<div class="post">
<h1>MBR</h1>

<p><em>主引导记录(Master Boot Record, MBR)是计算机开机访问硬盘时必须读取的首个扇区，三维地址为(柱面, 磁头, 扇区) = (0, 0, 1)。MBR存储硬盘本身的相关信息和分区的大小及位置信息，是数据信息的重要入口。MBR与操作系统无关。</em></p>

<p>MBR(512bytes)分3部分</p>

<ul>
<li>前446bytes存储引导代码，也称为MBR</li>
<li>接着4个16bytes的磁盘分区表(DPT)</li>
<li>最后是2bytes结束标志，0x55和0xAA</li>
</ul>

<p>BIOS按启动顺序依次读取存储设备的MBR，若未发现结束标志，则操作下一存储设备。若无合适设备，则显示相应错误信息并死机，否则将控制权交给此设备。启动设备运行引导代码，作用是检查分区表是否正确并且在系统硬件完成自检以后将控制权交给硬盘上的第二阶段引导程序(如GNU GRUB)。</p>

<p>DPT共64bytes，可对4个分区的信息进行描述，每个16bytes。每个字节具体定义为</p>

<ul>
<li>00H，1byte，分区状态，非活动分区00，活动分区80，其他无意义</li>
<li>01H，1byte，分区起始磁头号(HEAD)，全8位</li>
<li>02H，2bytes，分区起始扇区号(SECTOR),占据02H的0-5位；分区起始柱面号(CYLINDER),占据02H的6-7位和全部03H的8位</li>
<li>04H，1byte，文件系统标志位，如0B为FAT32</li>
<li>05H，1byte，分区结束磁头号，全8位</li>
<li>06H，2bytes，分区结束扇区号，占据06H的0-5位；分区结束柱面号，占据06H的6-7位和07H的8位</li>
<li>08H，4bytes，分区起始相对扇区号</li>
<li>0CH，4bytes，分区总扇区数</li>
</ul>

<p>由上可知，采用MBR型分区结构的硬盘最多只能有4个主分区(Primary partition)。为了得到更多分区，需要引入扩展分区，可在其中划分无数个逻辑分区。MBR分区表中最多只能有1个扩展分区，且Linux中扩展分区的分区号只能从5(如sda5)开始；对于大于8.4G的硬盘，CHS(24位)已无法表示，需使用<a href="http://zh.wikipedia.org/wiki/%E9%82%8F%E8%BC%AF%E5%8D%80%E5%A1%8A%E4%BD%8D%E5%9D%80" title="逻辑区块地址">LBA(Logical Block Address)</a>；4bytes扇区总数限制分区大小，最大2T，且每个分区的起始柱面必须在这个硬盘的前2T内。因此若有一块3T硬盘，则至少需要划分为两个分区，且第二个分区起始柱面需在前2T空间内。</p>

<p><em>以上各种分区、空间局限都在促使更合适的技术产生。</em></p>

<h1>GPT</h1>

<p><em>全局唯一标识分区表(GUID Partition Table, GPT)是一个实体硬盘的分区表的结构布局标准。GPT是EFI标准的一部分，用于替代MBR。多数操作系统已支持GPT，部分仅支持在EFI基础上自GPT启动，如Windows、OS X；Linux支持GPT用于基于BIOS的系统。</em></p>

<p>GPT使用LBA，以64位Windows为例(每个逻辑块512bytes)</p>

<ul>
<li>LBA 0，传统MBR</li>
<li>LBA 1，GPT头(分区表头)</li>
<li>LBA 2，分区表，使用32个逻辑块(16,384bytes)</li>
<li>LBA 34，第一个分区开始</li>
<li>LBA -2，备份分区表</li>
<li>LBA -1，备份GPT头，位于最后一个逻辑块</li>
</ul>

<p>GPT保留传统MBR，称为保护MBR，用于防止不支持GPT的硬盘管理工具错误识别并破坏硬盘中的数据。在支持从GPT启动的操作系统中，这里也用于存储第一阶段的启动代码，并且其中只有一个标识为0xEE的分区，以此来表示使用GPT分区表。在使用MBR/GPT混合分区表的硬盘中，MBR也用于存储GPT分区表的部分分区(通常前4个)以运行不支持GPT的操作系统。</p>

<p>GPT分区硬盘通过备份分区表头和分区表来提高分区数据结构的完整性，通过CRC32校验提高数据可靠性。分区表头定义了硬盘的可用空间以及组成分区表的项的大小和数量，还记录了这块硬盘的GUID、分区表头本身的位置和大小(位置总是在LBA 1)、备份分区表头和分区表的位置和大小(在硬盘的最后)、其本身和分区表的CRC32校验。</p>

<p>GPT分区表结构简单，每个分区信息占128bytes，每个字节具体含义</p>

<ul>
<li>16bytes，分区类型GUID(如EFI系统分区)</li>
<li>16bytes，分区GUID</li>
<li>8bytes，起始LBA</li>
<li>8bytes，末尾LBA</li>
<li>8bytes，属性标签(如60为只读)</li>
<li>72bytes，分区名</li>
</ul>

<p>相对于2T卷大小限制的MBR，GPT分配8bytes给逻辑块地址，理论最大分区大小可为2^64-1个扇区。除超大卷外，GPT无分区个数限制，但实际需受操作系统限制，如64位Windows分区表为16,384bytes，即最多可有128个分区。</p>

<p><em>EFI完成初始化和运行DXE后挂载EFI系统分区(ESP)，剩余工作完成后将控制权交给位于此分区的第二阶段引导程序，如GRUB。</em></p>

<h1>参看</h1>

<ul>
<li><a href="http://zh.wikipedia.org/wiki/%E4%B8%BB%E5%BC%95%E5%AF%BC%E8%AE%B0%E5%BD%95" title="主引导记录">MBR-维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80%E6%A8%99%E8%AD%98%E5%88%86%E5%8D%80%E8%A1%A8" title="全局唯一标识分区表">GPT-维基百科</a></li>
</ul>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                <a href="feed.xml">feed: rss 2.0</a><br />
                <a href="https://github.com/zp25">github.com/zp25</a><br />
                <a href="mailto:zebrap25@gmail.com" target="_blank">zebrap25@gmail.com</a>
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
