<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>非对称加密算法RSA和应用III - OPENVPN</title>
        <meta name="viewport" content="width=device-width">

        <!-- favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- RSS Feed -->
        <link rel="alternate" type="application/rss+xml" title="RSS" href="feed.xml">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">ZP</a></h1>
            <a class="extra" href="/">home</a>
            <a class="extra" href="/categories.html">categories</a>
          </div>

          <h2>非对称加密算法RSA和应用III - OPENVPN</h2>
<p class="meta">24 Jun 2014</p>

<div class="post">
<h1>VPN</h1>

<p>虚拟专用网(Virtual Private Network)是一种常用于连接中、大型企业或团体与团体间的私人网络的通讯方法。VPN可以实现通过不安全的网络架构(如因特网)，利用身份认证、加密等技术安全可靠的传输信息。常用的VPN协议有</p>

<h2>PPTP</h2>

<p>点对点隧道协议(PPTP)是微软、3Com等公司开发的虚拟隧道协议。PPTP使用TCP创建控制通道来发送控制命令，以及利用<a href="http://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E8%B7%AF%E7%94%B1%E5%B0%81%E8%A3%85" title="通用路由封装">通用路由封装(GRE)</a>通道来封装<a href="http://zh.wikipedia.org/wiki/%E7%82%B9%E5%AF%B9%E7%82%B9%E5%8D%8F%E8%AE%AE" title="点对点协议">点对点协议(PPP)</a>数据包以发送数据。PPTP本身不提供加密和身份验证功能，需配合微软<a href="http://msdn.microsoft.com/zh-cn/library/cc757532(v=ws.10).aspx" title="Microsoft 点对点加密 (MPPE)">点对点加密(MPPE)</a>。</p>

<h2>L2TP</h2>

<p>第二层隧道协议(Layer Two Tunneling Protocol)是由IETF根据PPTP提出的虚拟隧道协议，2005年L2TPv3通过RFC 3931发布。L2TP自身也不提供加密与身份验证，通常配合IPSec实现，称为L2TP/IPsec。L2TP是数据链路层协议，实现时不局限于IP网络，同时还支持ATM、帧中继、X.25在内的多种网络。</p>

<h2>IPSec</h2>

<p>互联网安全协定(Internet Protocol Security)是通过对IP协议的分组进行加密和认证来保护IP协议的网络传输协议族。IPSec属于网络层，通过加密封装IP数据包，可用于保护更高层的协议，如TCP、UDP等；而其他加密协议，如SSL位于应用层，则只能加密TCP信息流。但处于更低层则相应的必须处理可靠性和分片的问题，也使复杂性和处理开销较SSL高。</p>

<p>若用于构建VPN(IPSec的主要用途)，由于处于网络层，数据包到达内部网络即解密，因此在内部局域网中是明文传输。而处于应用层的SSL能保证应用间的安全传输。</p>

<p>开源软件<a href="https://www.openswan.org/" title="Openswan">Openswan</a>可提供IPsec功能。</p>

<h2>SSLVPN</h2>

<p>对比IPSec和SSL可以看出两者各自的优势，在某些情况下需要构建使用SSL加密的VPN。</p>

<p><a href="http://openvpn.net/" title="OpenVPN">OpenVPN</a>是一个用于创建VPN的软件包，大量使用<a href="http://www.openssl.org/" title="OpenSSL">OpenSSL</a>加密库中的SSLv3/TLSv1协议函数库。其技术核心是虚拟网卡和SSL。虚拟网卡是使用网络底层编程技术实现的一个驱动软件，运行后主机多出现一个网卡，可像其他网卡一样配置，数据包都需通过此虚拟网卡处理。</p>

<p>OpenVPN必须双向验证，也提供了多种验证方式，包括预享密钥(仅用于点对点VPN)、第三方证书、用户名密码组合(2.0起提供)。由于OpenVPN使用通用网络协议(TCP等)，因此可以防止ISP等过滤特定VPN协议，如IPSec。</p>

<h1>搭建OpenVPN</h1>

<p>整理这些内容实际是希望搭建一个VPN，在了解OpenVPN后引出了RSA算法和OpenSSL，于是就先做些准备，也方便之后使用HTTPS。教程参考<a href="https://help.ubuntu.com/14.04/serverguide/openvpn.html" title="OpenVPN">Ubuntu服务指南中VPN内容</a>，也参考了<a href="https://www.digitalocean.com/community/tutorials/how-to-setup-and-configure-an-openvpn-server-on-centos-6" title="How to Setup and Configure an OpenVPN Server on CentOS 6">这篇文章</a>。</p>

<h2>服务器端操作</h2>

<p>Ubuntu 14.04，首先安装，OpenVPN2.3开始不捆绑easy-rsa(简化生成证书)，因此也需手动安装</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">apt-get update &amp;&amp; apt-get install openvpn easy-rsa
</code></pre></div>
<p>由之前内容知道ssl运行需要密钥和数字证书，因此需先生成这些内容。复制easy-rsa到openvpn配置目录，然后编辑配置信息</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">mkdir /etc/openvpn/easy-rsa/
cp -r /usr/share/easy-rsa/* /etc/openvpn/easy-rsa/

cd /etc/openvpn/easy-rsa/
vim vars

# 配置，必填
export KEY_COUNTRY=&quot;US&quot;
export KEY_PROVINCE=&quot;CA&quot;
export KEY_CITY=&quot;SanFrancisco&quot;
export KEY_ORG=&quot;Example Company&quot;
export KEY_EMAIL=&quot;me@myhost.mydomain&quot;
export KEY_OU=&quot;MyOrganizationalUnit&quot;
export KEY_NAME=&quot;EasyRSA&quot;
</code></pre></div>
<p>接着生成CA证书，为根证书(Root CA certificate)，教程把<code>source vars</code>给翻译了...build-ca需要做一些选择，包括确认以上配置</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">source vars
./clean-all
./build-ca
</code></pre></div>
<p>客户端身份验证最常用的是通过第三方证书，因此下一步生成客户端证书，通常每个客户端有各自不同的证书。另外，可选添加&quot;HMAC firewall&quot;来阻止Dos和UDP port flooding攻击，原理是在TLS/SSL更高层添加一个安全层，先过滤HMAC特征不符的UDP包，也起到加快处理作用，因为TLS/SSL操作比较消耗时间。期间需要做一些选择，如填写可选的一个密码和公司名称，确认时也记得输入&#39;y&#39;</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># 服务器证书
source vars
./build-key-server server

# 客户端证书
source vars
./build-key client1
./build-key client2

# 服务器必须生成D-H参数，增强安全性，具体为什么，再查一查
./build-dh

# 添加&quot;HMAC firewall&quot;，记得之后的配置
openvpn --genkey --secret ta.key
</code></pre></div>
<p>结束后，除ta.key位于/etc/openvpn外，其他生成的内容都位于./keys目录，其中包括</p>

<ul>
<li>ca.crt，Root CA certificate，服务器和所有客户端都需要一份，因此不需保密</li>
<li>ca.key，Root CA key，用于签发私钥，保密</li>
<li>dh{n}.pem，迪菲－赫尔曼变量</li>
<li>server.crt，服务器证书，由根证书签发，其中包含服务器公钥，不需保密</li>
<li>server.key，服务器私钥，必须保密</li>
<li>client{n}.crt，客户端证书</li>
<li>client{n}.key，客户端私钥</li>
<li>ta.key，服务器和客户端都需要一份，但必须保密，因此必须在已存在的安全通道中传输</li>
</ul>

<p>通常执行以下任务，方便之后的配置</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">cp server.crt server.key ca.crt dh2048.pem /etc/openvpn/
</code></pre></div>
<p>之后是简单的服务器配置</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># 复制并解压配置文件
cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz \
    /etc/openvpn/
gzip -d /etc/openvpn/server.conf.gz

cd /etc/openvpn
vim server.conf
</code></pre></div>
<p>部分配置</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># 确保以下内容写入配置文件
ca ca.crt
cert myservername.crt
key myservername.key 
dh dh2048.pem

# 其他自选配置；协议使用udp因为可更好的防止Dos和UDP port flooding攻击
prot 1194
proto udp
comp-lzo

# 若希望将服务器作为客户端的网关(目的很明确嘛)则需去除以下内容的注释
# 使用Google Public DNS
push &quot;redirect-gateway def1 bypass-dhcp&quot;
push &quot;dhcp-option DNS 8.8.8.8&quot;
push &quot;dhcp-option DNS 8.8.4.4&quot;

# 将OpenVPN作为非特权用户运行是很好的安全策略，取消两行注释
user nobody
group nogroup

# &quot;HMAC firewall&quot;配置，第二个参数在服务器端为0，客户端为1
tls-auth ta.key 0
</code></pre></div>
<p>最后一步，非常重要，路由转发配置(目的很明确嘛)</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">vim /etc/sysctl.conf

# 取消ip_forward注释
net.ipv4.ip_forward = 1

# 退出vim后重新载入sysctl
sysctl -p
</code></pre></div>
<p>依照教程，直接修改iptables；由于服务器使用了ufw，所以找到了对应的配置方式，详细见<a href="http://www.gaggl.com/2013/04/openvpn-forward-all-client-traffic-through-tunnel-using-ufw/" title="OpenVPN – forward all client traffic through tunnel using UFW">这篇文章</a></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># 直接修改iptables
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
service iptables save

# 或使用ufw配置
# 先配置允许封包转发
vim /etc/default/ufw
DEFAULT_FORWARD_POLICY=&quot;ACCEPT&quot;

# 之后修改规则
vim /etc/ufw/before.rules

# 以下内容需添加在&quot;*filter&quot;行前，就是添加在规则的最前端
# START OPENVPN RULES
# NAT table rules
*nat
:POSTROUTING ACCEPT [0:0]
# Allow traffic from OpenVPN client to eth0
-A POSTROUTING -s 10.8.0.0/8 -o eth0 -j MASQUERADE
COMMIT
# END OPENVPN RULES
</code></pre></div>
<p>服务器端任务完成，以服务开启<code>service openvpn start</code>，或通过命令<code>openvpn</code>开启。开启后可查看生成的虚拟网卡信息<code>ifconfig tun0</code>。不要忘了开启端口<code>ufw allow 1194</code>。一切正常，进入客户端操作</p>

<h2>客户端操作</h2>

<p>客户端内容均测试通过，其中桌面为Ubuntu 14.04；ios为7.1.1；android为4.4.2</p>

<h3>Ubuntu</h3>

<p>选择OpenVPN client，因此客户端也需安装OpenVPN，并将之前生成的client1.crt client1.key ca.crt移至/etc/openvpn</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf \
    /etc/openvpn/

cd /etc/openvpn
vim client.conf
</code></pre></div>
<p>部分配置</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># 确保以下内容写入配置文件
ca ca.crt
cert client1.crt
key client1.key

# 注意修改服务器地址，端口和协议必须与服务器相同，服务器开启压缩则客户端也必须开启
remote vpnserver.example.com 1194
prot 1194
proto udp
comp-lzo

# 将OpenVPN作为非特权用户运行是很好的安全策略，取消两行注释
user nobody
group nogroup

# &quot;HMAC firewall&quot;配置，第二个参数在服务器端为0，客户端为1
tls-auth ta.key 1
</code></pre></div>
<p>配置完成，可开启客户端<code>service openvpn start</code>，同样也可以查看虚拟网卡信息<code>ifconfig tun0</code>，ping服务器是否在线<code>ping 10.8.0.1</code>，也可查看路由信息确定是否连接成功<code>netstat -rn</code></p>

<h3>ios</h3>

<p>app store下载官方OpenVPN Connect应用，编辑一份client.conf，将其重命名为.ovpn扩展名。将各种证书和密钥以in-line方式写入ovpn文件，具体样例见<a href="https://community.openvpn.net/openvpn/wiki/IOSinline" title="IOSinline">此文</a>。想办法将此配置文件移入ios设备，如通过邮件或iTunes同步等。完成后使用OpenVPN打开，跳转到OpenVPN后会看到有发现新配置的信息，右下方点击绿色的加号便可完成导入。打开服务测试。</p>

<h3>android</h3>

<p>android操作与ios几乎相同。安装官方OpenVPN Connect应用，制作ovpn文件后存入手机。打开OpenVPN，点击菜单，Import，选择ovpn文件导入。打开服务测试。</p>

<h2>使用其他方式进行客户端身份认证</h2>

<p>以上使用第三方证书方式认证，之前提到还有两种认证方式，静态密钥方式<a href="http://openvpn.net/index.php/open-source/documentation/miscellaneous/78-static-key-mini-howto.html" title="HOWTO-Static key configurations">查看此文</a>。另一种是OpenVPN2.0起可以选择的用户名/密码认证方式，简化认证，但我暂时不使用，没有经历就不太好发言，这里只是把手册中提到的设置方式整理出来，方便以后需要使用时查看。登录用户使用系统的local user和passwd。不需生成客户端证书，但ca.crt依然需要</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"># server.conf配置
# 声明使用openvpn-auth-pam扩展
plugin /usr/lib/openvpn/openvpn-plugin-auth-pam.so login

# 关闭证书认证而仅使用用户名/密码认证
client-cert-not-required
username-as-common-name


# client.conf配置
# 用户名和密码在连接时提供，加密传输给服务器后由以下配置触发认证
auth-user-pass

# 注释客户端证书和密钥内容
;cert client1.crt
;key client1.key
</code></pre></div>
<p>客户端连接时需输入用户名/密码。</p>

<h2>避免被防火墙拦截</h2>

<p>SSL在握手过程中是明文传输的，且看了几篇文章都说OpenVPN报文特征明显。有提到使用静态证书认证的，可以防止交换密钥时由于明显特征被阻拦OpenVPN服务的防火墙识别。还有是可以通过另一种不被拦截的服务通道传输OpenVPN报文，如SSH。</p>

<h1>参看</h1>

<ul>
<li><a href="http://zh.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN-维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF" title="虚拟专用网">虚拟专用网-维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E9%BB%9E%E5%B0%8D%E9%BB%9E%E9%9A%A7%E9%81%93%E5%8D%94%E8%AD%B0" title="点对点隧道协议">点对点隧道协议-维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/%E7%AC%AC%E4%BA%8C%E5%B1%82%E9%9A%A7%E9%81%93%E5%8D%8F%E8%AE%AE" title="第二层隧道协议">第二层隧道协议-维基百科</a></li>
<li><a href="http://zh.wikipedia.org/wiki/IPsec" title="IPsec">IPsec-维基百科</a></li>
<li><a href="https://www.x-berry.com/vpn-tunneling-protocol/" title="VPN 隧道协议PPTP、L2TP、IPSec和SSLVPN的区别">VPN 隧道协议PPTP、L2TP、IPSec和SSLVPN的区别</a></li>
<li><a href="http://openvpn.net/index.php/open-source/documentation/howto.html" title="HOWTO">OpenVPN文档-HOWTO</a></li>
</ul>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                <a href="feed.xml">feed: rss 2.0</a><br />
                <a href="https://github.com/zp25">github.com/zp25</a><br />
                <a href="mailto:zebrap25@gmail.com" target="_blank">zebrap25@gmail.com</a>
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
